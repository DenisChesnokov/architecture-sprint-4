# Выбор и настройка мониторинга в системе

## Мотивация

Внедрение комплексной системы мониторинга критически важно для компании "Александрит" по следующим причинам:

1. **Предотвращение потери бизнеса**
   - Компания теряет крупные B2B контракты из-за проблем с заказами
   - Растет недовольство B2C клиентов
   - Отсутствует видимость проблем до получения жалоб от клиентов

2. **Производственные проблемы**
   - Операторы жалуются на медленную загрузку MES
   - Длительное время расчета стоимости (до 30 минут)
   - Отсутствие контроля над "потерянными" заказами

3. **Масштабирование бизнеса**
   - Линейный рост заказов (+100 ежемесячно)
   - Расширение на B2B рынок через API
   - Необходимость планирования мощностей

## Выбор подхода к мониторингу

Для разных компонентов системы будем использовать различные подходы:

### 1. Клиентские API (Shop API, CRM API, MES API)
**Подход: RED (Rate, Errors, Duration)**
- Подходит для сервисов, обрабатывающих запросы
- Фокус на пользовательском опыте
- Простота интерпретации метрик

### 2. Инфраструктура (БД, EC2, S3)
**Подход: USE (Utilization, Saturation, Errors)**
- Оптимален для мониторинга ресурсов
- Помогает в планировании мощностей
- Раннее обнаружение проблем с ресурсами

### 3. Бизнес-процессы (Обработка заказов)
**Подход: Четыре золотых сигнала**
- Latency: время обработки заказов
- Traffic: количество заказов
- Errors: проблемы в процессе
- Saturation: загрузка системы заказами

## Метрики для отслеживания

### Очереди сообщений (RabbitMQ)

1. **Number of dead-letter-exchange letters in RabbitMQ**
   - Назначение: Обнаружение "потерянных" заказов
   - Ярлыки:
     * queue_name
     * message_type
     * source_service

2. **Number of message in flight in RabbitMQ**
   - Назначение: Контроль загруженности очередей
   - Ярлыки:
     * queue_name
     * priority
     * message_type

### API Endpoints

3. **Number of requests (RPS) для всех API**
   - Назначение: Мониторинг нагрузки на систему
   - Ярлыки:
     * service_name
     * endpoint
     * client_type (B2B/B2C)

4. **Response time (latency) для всех API**
   - Назначение: Контроль производительности
   - Ярлыки:
     * service_name
     * endpoint
     * percentile (p50, p95, p99)

5. **HTTP статус коды (200, 500) для всех API**
   - Назначение: Мониторинг ошибок
   - Ярлыки:
     * service_name
     * endpoint
     * error_type

### Ресурсы

6. **CPU % для всех API**
   - Назначение: Контроль утилизации
   - Ярлыки:
     * service_name
     * instance_id
     * region

7. **Memory Utilisation для всех сервисов**
   - Назначение: Предотвращение OOM
   - Ярлыки:
     * service_name
     * instance_id
     * memory_type (heap/non-heap)

8. **Метрики БД**
   - Назначение: Производительность баз данных
   - Метрики:
     * Number of connections
     * Memory Utilisation
     * Size of instance
   - Ярлыки:
     * database_name
     * instance_type
     * query_type (read/write)

### Дополнительные метрики

9. **Время обработки заказа по статусам**
   - Назначение: Контроль SLA
   - Ярлыки:
     * status
     * order_type
     * client_type

10. **Количество активных операторов**
    - Назначение: Планирование ресурсов
    - Ярлыки:
     * shift
     * specialization
     * workload

## План действий

1. **Инфраструктура мониторинга**
   - Развернуть Prometheus для сбора метрик
   - Настроить Grafana для визуализации
   - Установить Alertmanager для оповещений

2. **Инструментирование приложений**
   - Добавить Prometheus клиенты во все сервисы
   - Настроить экспортеры для RabbitMQ и баз данных
   - Реализовать custom метрики для бизнес-процессов

3. **Настройка алертинга**
   - Определить пороговые значения для алертов
   - Настроить маршрутизацию оповещений
   - Интеграция с системой инцидентов

4. **Документация и обучение**
   - Создать runbook'и для типовых проблем
   - Провести обучение команды
   - Документировать процесс эскалации

## Пороговые значения и действия (дополнительно)

### Критические метрики

1. **Latency API**
   - Порог: p95 > 1000ms
   - Действия:
     * Автоматическое масштабирование
     * Алерт команде разработки
     * Создание инцидента при превышении 5 минут

2. **Error Rate**
   - Порог: >1% ошибок за 5 минут
   - Действия:
     * Немедленное оповещение on-call инженера
     * Автоматическое создание инцидента
     * Запуск диагностических скриптов

3. **Dead Letters**
   - Порог: >10 сообщений за час
   - Действия:
     * Оповещение команды поддержки
     * Автоматический анализ паттернов
     * Создание тикета на расследование

4. **Resource Utilization**
   - CPU Порог: >80% за 5 минут
   - Memory Порог: >85% использования
   - Действия:
     * Автоматическое масштабирование
     * Уведомление DevOps команды
     * Анализ причин высокой нагрузки